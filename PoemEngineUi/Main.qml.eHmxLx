import QtQuick 2.15
import QtQuick.Controls 2.15
import QtQuick.Layouts 1.15
import QtQuick.Controls.Material

Window {
    id: root
    width: 480
    height: 640
    title: qsTr("è¯—å¥æ£€ç´¢")

    visible: true
    Component.onCompleted: QtQuickControls2.style = "Material" // è®¾ç½®å…¨å±€æ ·å¼ä¸º Material

    ColumnLayout {
        anchors.fill: parent
        anchors.margins: 16
        spacing: 12

        // é¡¶éƒ¨æœç´¢æ 
        RowLayout {
            Layout.fillWidth: true
            spacing: 8

            Label {
                text: "è©©é¡Œ"
            }

            TextField {
                id: inputTitle
                padding: 4
                Layout.fillWidth: true
                placeholderText: "è©©é¡Œ..."
                Layout.preferredHeight: 32

            }

            Label {
                text: "è¨€æ•¸"
            }

            TextField {
                id: inputYan
                padding: 4
                placeholderText: "ç¤ºä¾‹: 5"
                Layout.preferredHeight: 32
                Layout.preferredWidth: 60
            }

            Label {
                text: "å¥æ•¸"
            }

            TextField {
                id: inputJushu
                padding: 4
                placeholderText: "ç¤ºä¾‹: 8"
                Layout.preferredHeight: 32
                Layout.preferredWidth: 60

            }
        }
        // é¡¶éƒ¨æœç´¢æ 
        RowLayout {
            Layout.fillWidth: true
            spacing: 8

            Label {
                text: "ä½œè€…"
            }

            TextField {
                id: inputAuthor
                padding: 4
                Layout.fillWidth: true
                placeholderText: "ä½œè€…..."
                Layout.preferredHeight: 32

            }

            Label {
                text: "é«”è£"
            }

            TextField {
                id: inputTicai
                padding: 4
                placeholderText: "(å¾‹è©©)"
                Layout.preferredHeight: 32
                Layout.preferredWidth: 60

            }

            Label {
                text: "å¥åº"
            }

            TextField {
                id: inputJuind
                padding: 4
                placeholderText: "ç¤ºä¾‹: 1"
                Layout.preferredHeight: 32
                Layout.preferredWidth: 60

            }

        }

        // é¡¶éƒ¨æœç´¢æ 
        RowLayout {
            Layout.fillWidth: true
            spacing: 8

            Label {
                text: "è©©å¥"
            }

            TextField {
                id: inputJu
                padding: 4
                Layout.fillWidth: true
                placeholderText: "è¼¸å…¥è©©å¥..."
                Layout.preferredHeight: 32

            }

            Label {
                text: "å¹³ä»„"
            }

            TextField {
                id: inputPz
                padding: 4
                Layout.fillWidth: true
                placeholderText: "è¼¸å…¥å¹³ä»„æ ¼å¼..."
                Layout.preferredHeight: 32

            }

            Button {
                text: "ğŸ”"
                onClicked: {
                    // è°ƒç”¨ C++ æœç´¢é€»è¾‘
                    interf.onQuery(inputJu.text,
                                 inputPz.text,
                                 inputTitle.text,
                                 inputAuthor.text,
                                 inputYan.text,
                                 inputJushu.text,
                                 inputTicai.text,
                                 inputJuind.text)
                    // poemManager.query(searchInput.text)
                }
                Layout.preferredHeight: 32
            }
        }

        // æ¨¡å¼ + é€‰é¡¹åŒº
        // ColumnLayout {
        //     spacing: 6

        //     RowLayout {
        //         Label { text: "æŸ¥è©¢æ¨¡å¼ï¼š" }
        //         ComboBox {
        //             id: modeSelect
        //             model: ["å…¨éƒ¨", "è©©å¥", "å¹³ä»„"]
        //             Layout.preferredHeight: 32
        //         }
        //     }

        //     ColumnLayout {
        //         CheckBox { id: opt2; text: "ç°¡ç¹ã€ç•°é«”è½‰æ›"; checked: true }
        //     }
        // }

        // æ»šåŠ¨è§†å›¾åŒºåŸŸ
        ScrollView {
            id: scrollView
            Layout.fillWidth: true
            Layout.fillHeight: true
            ScrollBar.vertical.policy: ScrollBar.AlwaysOn  // ç¡®ä¿å§‹ç»ˆæ˜¾ç¤ºæ»šåŠ¨æ¡

            ListView {
                id: listView
                anchors.fill: parent
                model: interf.model
                spacing: 2
                clip: true

                delegate: Rectangle {
                    property string col7str: model.col7
                    property string col9str: model.col9
                    id: delegateItem
                    width: listView.width
                    height: 60
                    color: mouseArea.pressed ? "#e0e0e0" : "white"

                    // ç‚¹å‡»æ•ˆæœ
                    MouseArea {
                        id: mouseArea
                        anchors.fill: parent
                        onClicked: {
                            popup.author = model.col0
                            popup.content = model.col1
                            popup.chulv = model.col2
                            popup.jushu = model.col3
                            popup.yan = model.col4
                            popup.title = model.col5
                            popup.ticai = model.col6
                            popup.ju = model.col7
                            popup.juind = model.col8
                            popup.pz = model.col9
                            popup.open()
                        }
                    }

                    RowLayout {
                        anchors.fill: parent
                        spacing: 10

                        // å·¦ä¾§å¤§å­—ä½“
                        Text {
                            textFormat: Text.RichText
                            font.pixelSize: 20
                            font.bold: true
                            text: {
                                var str = ""
                                for (var i = 0; i < model.col7.length; ++i) {
                                    var c = model.col7.charAt(i)
                                    var color = model.col9.charAt(i) === "ä»„" ? "#C55A11" : "#3B3838"
                                    str += "<span style='color:" + color + "'>" + c + "</span>"
                                }
                                return str
                            }
                            Layout.fillHeight: true
                            Layout.preferredWidth: 140
                            verticalAlignment: Text.AlignVCenter
                        }

                        // Text {
                            // text: model.col7
                            // font.pixelSize: 20
                            // font.bold: true
                            // Layout.leftMargin: 10
                            // Layout.fillHeight: true
                            // Layout.preferredWidth: 140
                            // verticalAlignment: Text.AlignVCenter
                        // }

                        // å³ä¾§ä¸Šä¸‹å¸ƒå±€
                        ColumnLayout {
                            Layout.fillWidth: true
                            Layout.fillHeight: true
                            spacing: 2

                            RowLayout {
                                Layout.fillWidth: true
                                Layout.fillHeight: true
                                Text {
                                    text: model.col0 + " ã€Š" + model.col5 + "ã€‹"
                                    font.pixelSize: 14
                                    font.bold: true
                                    color: "#444444"
                                    Layout.alignment: Qt.AlignLeft | Qt.AlignVCenter
                                    Layout.fillHeight: true
                                }
                            }

                            RowLayout {
                                Layout.fillWidth: true
                                Layout.fillHeight: true
                                Text {
                                    text: "é«”è£ï¼š" + model.col6
                                    font.pixelSize: 14
                                    color: "#444444"
                                    Layout.alignment: Qt.AlignLeft | Qt.AlignVCenter
                                    Layout.preferredWidth: 80
                                    Layout.fillHeight: true
                                }
                                Text {
                                    text: "ç¬¬" + model.col8 + "å¥"
                                    font.pixelSize: 14
                                    color: "#444444"
                                    Layout.alignment: Qt.AlignLeft | Qt.AlignVCenter
                                    Layout.fillWidth: true
                                    Layout.fillHeight: true
                                }
                            }
                        }
                    }

                    // åˆ†å‰²çº¿
                    Rectangle {
                        width: parent.width
                        height: 1
                        color: "#eee"
                        anchors.bottom: parent.bottom
                    }
                }
            }
        }
        // TableView {
        //     id: tableView
        //     Layout.fillWidth: true
        //     Layout.fillHeight: true
        //     // selectionBehavior: TableView.SelectRows
        //     // selectionMode: TableView.SingleSelection
        //     // horizontalScrollBarPolicy: ScrollBar.AlwaysOff
        //     // ScrollBar.horizontal.policy: ScrollBar.AlwaysOff  // ç¦ç”¨æ°´å¹³æ»šåŠ¨
        //     // ScrollBar.vertical.policy: ScrollBar.AlwaysOn     // å§‹ç»ˆæ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡
        //     // è‡ªåŠ¨åˆ—å®½é…ç½®
        //     // columnWidthProvider: function(column) {
        //     //     return width / columnCount;
        //     // }
        //     delegate: Rectangle {
        //         required property bool selected
        //         // implicitWidth: 150
        //         // implicitWidth: textItem.implicitWidth + 20
        //         implicitHeight: 30
        //         border.width: 0.5
        //         border.color: "#bbbbbb"
        //         color: "transparent"

        //         Text {
        //             text: display
        //             anchors.centerIn: parent
        //         }
        //     }

        //     columnWidthProvider: function(column) {
        //         switch(column)
        //         {
        //         case 0:
        //             return 120;
        //         case 1:
        //             return 200;
        //         case 2:
        //             return 80;
        //         }
        //     }

        //     model: interf.model
        // }
        // æŸ¥è¯¢ç»“æœå±•ç¤ºåŒº
        // ScrollView {
        //     Layout.fillWidth: true
        //     Layout.fillHeight: true
        //     ScrollBar.horizontal.policy: ScrollBar.AlwaysOff  // ç¦ç”¨æ°´å¹³æ»šåŠ¨
        //     ScrollBar.vertical.policy: ScrollBar.AlwaysOn     // å§‹ç»ˆæ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡

        //     Rectangle {
        //         id: resultArea
        //         width: parent.width

        //         Column {
        //             spacing: 12
        //             Repeater {
        //                 model: resultModel
        //                 delegate: Rectangle {
        //                     width: parent.width
        //                     height: 100
        //                     radius: 8
        //                     color: "#ffffff"
        //                     border.color: "#cccccc"
        //                     border.width: 1

        //                     Text {
        //                         text: model.character + " - " + model.reading
        //                         font.pointSize: 16
        //                     }
        //                 }
        //             }
        //         }
        //     }
        // }

        // è¿›åº¦æ¡ä¸çŠ¶æ€æ ‡ç­¾
        RowLayout {
            Layout.fillWidth: true
            visible: bar.visible

            // ProgressBar {
            //     id: bar
            //     Layout.fillWidth: true
            //     value: 0.0
            // }

            Label {
                id: lab
                text: interf.labText
                horizontalAlignment: Text.AlignRight
            }
        }
    }

    Popup {
        id: popup
        modal: true
        focus: true

        width: parent.width * 4 / 5
        anchors.centerIn: Overlay.overlay  // âœ… å§‹ç»ˆå±…ä¸­

        // æ•°æ®å±æ€§
        property string author: ""
        property string content: ""
        property string chulv: ""
        property string jushu: ""
        property string yan: ""
        property string title: ""
        property string ticai: ""
        property string ju: ""
        property string juind: ""
        property string pz: ""

        // å¯Œæ–‡æœ¬å†…å®¹ï¼šå°† ju åŠ ç²—
        property string richContent: {
            const lines = []
            const regex = /[^ï¼Œã€‚ï¼Ÿï¼ï¼›]+[ï¼Œã€‚ï¼Ÿï¼ï¼›]/g
            const matches = popup.content.match(regex) || []
            const maxGroup = 5

            let i = 0
            while (i < matches.length) {
                let current = matches[i]
                const endChar = current.slice(-1)

                // Case A: å½“å‰æ˜¯é€—å·ï¼Œä¸‹ä¸€å¥ä¸æ˜¯é€—å·ç»“å°¾ â†’ åˆå¹¶ i å’Œ i+1
                if (endChar === "ï¼Œ" && i + 1 < matches.length && matches[i + 1].slice(-1) !== "ï¼Œ") {
                    current += matches[i + 1]
                    i += 2
                }
                // Case B: è¿ç»­å¥éå¥å·ç»“å°¾ï¼Œæœ€å¤šåˆå¹¶5å¥ï¼Œç›´åˆ°å¥å·
                else {
                    let group = current
                    let j = i + 1
                    while (j < matches.length && j - i < maxGroup && matches[j - 1].slice(-1) !== "ã€‚" && matches[j].slice(-1) !== "ã€‚") {
                        group += matches[j]
                        j += 1
                    }
                    // æ£€æŸ¥æ˜¯å¦æœ€åä¸€å¥æ˜¯å¥å·ç»“å°¾
                    if (j < matches.length && matches[j].slice(-1) === "ã€‚") {
                        group += matches[j]
                        j += 1
                    }
                    current = group
                    i = j
                }

                lines.push(current)
            }
            let joined = lines.join("<br/>")
            if (popup.ju.length === 0) return joined
            return joined.replace(popup.ju, "<b>" + popup.ju + "</b>")
            // return popup.content
        }

        // è‡ªåŠ¨é«˜åº¦ï¼ˆç”± Layout è‡ªåŠ¨å†³å®šï¼‰
        contentItem: ColumnLayout {
            anchors.fill: parent
            anchors.margins: 16
            spacing: 12

            // ç¬¬ä¸€éƒ¨åˆ†ï¼šæ ‡é¢˜ï¼Œå±…ä¸­æ˜¾ç¤º
            Text {
                text: popup.author + " ã€Š" + popup.title + "ã€‹"
                font.pixelSize: 14
                font.bold: true
                horizontalAlignment: Text.AlignHCenter
                Layout.alignment: Qt.AlignHCenter
                Layout.preferredWidth: popup.width - 32
                wrapMode: Text.Wrap
            }

            // ç¬¬äºŒéƒ¨åˆ†ï¼šå¯Œæ–‡æœ¬ï¼Œè‡ªåŠ¨æ¢è¡Œï¼Œé™åˆ¶å®½åº¦
            Text {
                textFormat: Text.RichText
                text: popup.richContent
                horizontalAlignment: Text.AlignHCenter
                Layout.alignment: Qt.AlignHCenter
                wrapMode: Text.Wrap
                font.pixelSize: 16
                Layout.preferredWidth: popup.width - 32
            }
        }
    }

    // Drawer {
    //     id: drawer
    //     width: root.width * 0.33
    //     height: root.height

    //     Column {
    //         anchors.fill: parent

    //         ItemDelegate {
    //             text: qsTr("Page 1")
    //             width: parent.width
    //             onClicked: {
    //                 stackView.push("Screen01.ui.qml")
    //                 drawer.close()
    //             }
    //         }
    //         ItemDelegate {
    //             text: qsTr("Page 2")
    //             width: parent.width
    //             onClicked: {
    //                 stackView.push("Screen02.ui.qml")
    //                 drawer.close()
    //             }
    //         }
    //     }
    // }
}

